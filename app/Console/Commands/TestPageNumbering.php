<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use App\Models\Document;
use App\Models\User;
use App\Services\Documents\Files\WordDocumentService;
use App\Services\Files\FilesService;

class TestPageNumbering extends Command
{
    protected $signature = 'test:page-numbering';
    protected $description = 'Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð½ÑƒÐ¼ÐµÑ€Ð°Ñ†Ð¸ÑŽ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ð¸ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‚Ð¸Ñ‚ÑƒÐ»ÑŒÐ½Ñ‹Ð¹ Ð»Ð¸ÑÑ‚';

    public function handle()
    {
        $this->info('ðŸ“„ Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½ÑƒÐ¼ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ð¸ Ñ‚Ð¸Ñ‚ÑƒÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð»Ð¸ÑÑ‚Ð°...');
        
        try {
            // ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
            $user = User::first();
            if (!$user) {
                $this->error('âŒ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð½Ð¸ Ð¾Ð´Ð¸Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ');
                return self::FAILURE;
            }
            
            // ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð¸Ð¿ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°
            $documentType = \App\Models\DocumentType::first();
            if (!$documentType) {
                $documentType = \App\Models\DocumentType::create([
                    'name' => 'Ð¢ÐµÑÑ‚Ð¾Ð²Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°',
                    'slug' => 'test-work',
                    'description' => 'Ð”Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ'
                ]);
            }
            
            // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ñ Ð¿Ð¾Ð»Ð½Ñ‹Ð¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ñ‹Ð¼
            $document = new Document([
                'title' => 'ÐÐ½Ð°Ð»Ð¸Ð· ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¼ÐµÑ‚Ð¾Ð´Ð¾Ð² Ð¸ÑÐºÑƒÑÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚Ð°',
                'user_id' => $user->id,
                'document_type_id' => $documentType->id,
                'status' => 'full_generated',
                'structure' => [
                    'topic' => 'ÐÐ½Ð°Ð»Ð¸Ð· ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¼ÐµÑ‚Ð¾Ð´Ð¾Ð² Ð¸ÑÐºÑƒÑÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚Ð°',
                    'contents' => [
                        [
                            'title' => 'Ð’Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ',
                            'subtopics' => [
                                ['title' => 'ÐÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ñ‚ÐµÐ¼Ñ‹'],
                                ['title' => 'Ð¦ÐµÐ»Ð¸ Ð¸ Ð·Ð°Ð´Ð°Ñ‡Ð¸']
                            ]
                        ],
                        [
                            'title' => 'ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ‡Ð°ÑÑ‚ÑŒ',
                            'subtopics' => [
                                ['title' => 'ÐžÐ±Ð·Ð¾Ñ€ Ð»Ð¸Ñ‚ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹'],
                                ['title' => 'ÐœÐµÑ‚Ð¾Ð´Ð¾Ð»Ð¾Ð³Ð¸Ñ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ']
                            ]
                        ]
                    ],
                    'references' => [
                        [
                            'title' => 'Ð¡Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ñ‹ Ð¼Ð°ÑˆÐ¸Ð½Ð½Ð¾Ð³Ð¾ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ',
                            'author' => 'Ð˜Ð²Ð°Ð½Ð¾Ð² Ð˜Ð²Ð°Ð½ Ð˜Ð²Ð°Ð½Ð¾Ð²Ð¸Ñ‡',
                            'url' => 'https://cyberleninka.ru/article/example',
                            'type' => 'article',
                            'description' => 'ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð° Ð¿Ð¾ Ñ‚ÐµÐ¼Ðµ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ'
                        ],
                        [
                            'title' => 'ÐžÑÐ½Ð¾Ð²Ñ‹ Ð½ÐµÐ¹Ñ€Ð¾Ð½Ð½Ñ‹Ñ… ÑÐµÑ‚ÐµÐ¹',
                            'author' => 'ÐŸÐµÑ‚Ñ€Ð¾Ð² ÐŸÐµÑ‚Ñ€ ÐŸÐµÑ‚Ñ€Ð¾Ð²Ð¸Ñ‡',
                            'publisher' => 'ÐÐ°ÑƒÐºÐ°',
                            'year' => '2023',
                            'type' => 'book',
                            'description' => 'Ð¤ÑƒÐ½Ð´Ð°Ð¼ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð° Ð¿Ð¾ Ð½ÐµÐ¹Ñ€Ð¾ÑÐµÑ‚ÑÐ¼'
                        ]
                    ]
                ],
                'content' => [
                    'topics' => [
                        [
                            'title' => 'Ð’Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ',
                            'subtopics' => [
                                [
                                    'title' => 'ÐÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ñ‚ÐµÐ¼Ñ‹',
                                    'content' => 'Ð’ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¼ Ð¼Ð¸Ñ€Ðµ Ð¸ÑÐºÑƒÑÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚ Ð¸Ð³Ñ€Ð°ÐµÑ‚ Ð²ÑÐµ Ð±Ð¾Ð»ÐµÐµ Ð²Ð°Ð¶Ð½ÑƒÑŽ Ñ€Ð¾Ð»ÑŒ Ð² Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… ÑÑ„ÐµÑ€Ð°Ñ… Ð´ÐµÑÑ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°. Ð Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ Ñ‚ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ð¹ Ð¼Ð°ÑˆÐ¸Ð½Ð½Ð¾Ð³Ð¾ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸ Ð³Ð»ÑƒÐ±Ð¾ÐºÐ¾Ð³Ð¾ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð´Ð»Ñ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ ÑÐ»Ð¾Ð¶Ð½Ñ‹Ñ… Ð·Ð°Ð´Ð°Ñ‡. Ð”Ð°Ð½Ð½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð° Ð¿Ð¾ÑÐ²ÑÑ‰ÐµÐ½Ð° Ð°Ð½Ð°Ð»Ð¸Ð·Ñƒ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¼ÐµÑ‚Ð¾Ð´Ð¾Ð² Ð˜Ð˜ Ð¸ Ð¸Ñ… Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¼Ñƒ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸ÑŽ.'
                                ],
                                [
                                    'title' => 'Ð¦ÐµÐ»Ð¸ Ð¸ Ð·Ð°Ð´Ð°Ñ‡Ð¸',
                                    'content' => 'Ð¦ÐµÐ»ÑŒÑŽ Ð´Ð°Ð½Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ ÑÐ²Ð»ÑÐµÑ‚ÑÑ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑÐ½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¼ÐµÑ‚Ð¾Ð´Ð¾Ð² Ð¸ÑÐºÑƒÑÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚Ð°. ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸: Ð¸Ð·ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚ÐµÐ¾Ñ€ÐµÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾ÑÐ½Ð¾Ð²Ñ‹ Ð˜Ð˜, Ð¿Ñ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ñ‹, Ñ€Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ.'
                                ]
                            ]
                        ],
                        [
                            'title' => 'ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ‡Ð°ÑÑ‚ÑŒ',
                            'subtopics' => [
                                [
                                    'title' => 'ÐžÐ±Ð·Ð¾Ñ€ Ð»Ð¸Ñ‚ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹',
                                    'content' => 'ÐÐ½Ð°Ð»Ð¸Ð· Ð½Ð°ÑƒÑ‡Ð½Ð¾Ð¹ Ð»Ð¸Ñ‚ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð² Ð¾Ð±Ð»Ð°ÑÑ‚Ð¸ Ð¸ÑÐºÑƒÑÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚Ð° Ð½Ð°Ð±Ð»ÑŽÐ´Ð°ÐµÑ‚ÑÑ ÑÑ‚Ñ€ÐµÐ¼Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ. ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ð¼Ð¸ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸ÑÐ¼Ð¸ ÑÐ²Ð»ÑÑŽÑ‚ÑÑ Ð¼Ð°ÑˆÐ¸Ð½Ð½Ð¾Ðµ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ, ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€Ð½Ð¾Ðµ Ð·Ñ€ÐµÐ½Ð¸Ðµ, Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ ÑÐ·Ñ‹ÐºÐ° Ð¸ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¾Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ°.'
                                ],
                                [
                                    'title' => 'ÐœÐµÑ‚Ð¾Ð´Ð¾Ð»Ð¾Ð³Ð¸Ñ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ',
                                    'content' => 'Ð’ Ñ…Ð¾Ð´Ðµ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»Ð¸ÑÑŒ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¼ÐµÑ‚Ð¾Ð´Ñ‹: Ð°Ð½Ð°Ð»Ð¸Ð· Ð½Ð°ÑƒÑ‡Ð½Ð¾Ð¹ Ð»Ð¸Ñ‚ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹, ÑÑ€Ð°Ð²Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ð¾Ð², ÑÐºÑÐ¿ÐµÑ€Ð¸Ð¼ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð³Ð¸Ð¿Ð¾Ñ‚ÐµÐ·. Ð˜ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ð²Ð¾Ð´Ð¸Ð»Ð¾ÑÑŒ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ‚ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ð¹.'
                                ]
                            ]
                        ]
                    ]
                ]
            ]);
            
            $document->save();
            
            // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Word Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚
            $filesService = app(FilesService::class);
            $wordService = new WordDocumentService($filesService);
            
            $file = $wordService->generate($document);
            
            $this->info("âœ… Word Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ñ Ð½ÑƒÐ¼ÐµÑ€Ð°Ñ†Ð¸ÐµÐ¹ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† ÑÐ¾Ð·Ð´Ð°Ð½!");
            $this->line("ðŸ“„ ID Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°: {$document->id}");
            $this->line("ðŸ“ Ð¤Ð°Ð¹Ð»: {$file->name}");
            $this->line("ðŸ”— ÐŸÑƒÑ‚ÑŒ: {$file->path}");
            
            $this->line('');
            $this->line('ðŸ“‹ ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°:');
            $this->line('  ðŸŽ¯ Ð¢Ð¸Ñ‚ÑƒÐ»ÑŒÐ½Ñ‹Ð¹ Ð»Ð¸ÑÑ‚ Ð±ÐµÐ· Ð½Ð¾Ð¼ÐµÑ€Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹');
            $this->line('  ðŸ“ Ð“Ð¾Ñ€Ð¾Ð´ Ð¸ Ð³Ð¾Ð´ Ð² Ð½Ð¸Ð¶Ð½ÐµÐ¼ ÐºÐ¾Ð»Ð¾Ð½Ñ‚Ð¸Ñ‚ÑƒÐ»Ðµ Ñ‚Ð¸Ñ‚ÑƒÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð»Ð¸ÑÑ‚Ð°');
            $this->line('  ðŸ”¢ ÐÑƒÐ¼ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ð´Ð»Ñ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ñ, Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÐºÑÑ‚Ð° Ð¸ ÑÑÑ‹Ð»Ð¾Ðº');
            $this->line('  ðŸ“– Ð’ÑÐµ ÑÑÑ‹Ð»ÐºÐ¸ Ð¾Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð¿Ð¾ Ð“ÐžÐ¡Ð¢ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð°Ð¼');
            $this->line('  ðŸ“ Ð—Ð°Ð³Ð»ÑƒÑˆÐºÐ¸ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð² Ñ‚Ð¸Ñ‚ÑƒÐ»ÑŒÐ½Ð¾Ð¼ Ð»Ð¸ÑÑ‚Ðµ');
            
            // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚
            $document->delete();
            
            $this->line('');
            $this->info('ðŸ§¹ Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ ÑƒÐ´Ð°Ð»ÐµÐ½ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…');
            
        } catch (\Exception $e) {
            $this->error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: " . $e->getMessage());
            return self::FAILURE;
        }

        return self::SUCCESS;
    }
} 