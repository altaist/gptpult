# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ "Can't add messages to thread while a run is active"

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
OpenAI Add Message failed: {
  "error": {
    "message": "Can't add messages to thread_on6dsL6MQejd0D114xsZVhza while a run run_70qP9AgOfqoLVAbeSvOE9Cwn is active.",
    "type": "invalid_request_error",
    "param": null,
    "code": null
  }
}
```

### –ü—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏

–í –ø—Ä–æ—Ü–µ—Å—Å–µ **–ø–æ–ª–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞** (`StartFullGenerateDocument`) —Å–∏—Å—Ç–µ–º–∞:
1. ‚úÖ –ñ–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ run —á–µ—Ä–µ–∑ `waitForRunCompletion()`
2. ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
3. ‚ùå **–°—Ä–∞–∑—É –∂–µ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ thread
4. ‚ùå –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π run

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ OpenAI Assistants API v2, –Ω–µ–ª—å–∑—è –¥–æ–±–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ thread, –ø–æ–∫–∞ –∞–∫—Ç–∏–≤–µ–Ω run. –ú–µ–∂–¥—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º run –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ OpenAI.

## üõ†Ô∏è –†–µ—à–µ–Ω–∏–µ

### 1. –ù–æ–≤—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ç–æ–¥ `safeAddMessageToThread()`

–î–æ–±–∞–≤–ª–µ–Ω –≤ `OpenAiService`:

```php
public function safeAddMessageToThread(string $threadId, string $content, int $maxRetries = 5): array
{
    $attempts = 0;
    
    while ($attempts < $maxRetries) {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ run –≤ thread
            if ($this->hasActiveRuns($threadId)) {
                Log::info('Thread –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ run, –æ–∂–∏–¥–∞–µ–º...', [
                    'thread_id' => $threadId,
                    'attempt' => $attempts + 1
                ]);
                
                sleep(2);
                $attempts++;
                continue;
            }
            
            // –ü—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
            return $this->addMessageToThread($threadId, $content);
            
        } catch (\Exception $e) {
            if (strpos($e->getMessage(), 'while a run') !== false && 
                strpos($e->getMessage(), 'is active') !== false) {
                
                // –ñ–¥–µ–º –¥–æ–ª—å—à–µ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö
                sleep(min(5, 2 + $attempts));
                $attempts++;
                continue;
            }
            
            throw $e;
        }
    }
    
    throw new \Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ thread –ø–æ—Å–ª–µ {$maxRetries} –ø–æ–ø—ã—Ç–æ–∫.");
}
```

### 2. –ú–µ—Ç–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö run

```php
public function hasActiveRuns(string $threadId): bool
{
    try {
        $response = $this->getHttpClient([
            'OpenAI-Beta' => 'assistants=v2',
        ])->get("https://api.openai.com/v1/threads/{$threadId}/runs");

        if (!$response->successful()) {
            return false;
        }

        $runs = $response->json();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ run
        foreach ($runs['data'] ?? [] as $run) {
            if (in_array($run['status'], ['queued', 'in_progress', 'requires_action'])) {
                return true;
            }
        }
        
        return false;
        
    } catch (\Exception $e) {
        return false;
    }
}
```

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö Job'–æ–≤

–ó–∞–º–µ–Ω–µ–Ω—ã –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –≤—ã–∑–æ–≤—ã –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –º–µ—Ç–æ–¥—ã:

**–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π:**
- ‚úÖ `addMessageToThread()` ‚Üí `safeAddMessageToThread()` –≤–æ –≤—Å–µ—Ö Job'–∞—Ö

**–°–æ–∑–¥–∞–Ω–∏–µ run:**  
- ‚úÖ `createRun()` ‚Üí `safeCreateRun()` –≤–æ –≤—Å–µ—Ö Job'–∞—Ö

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ñ–∞–π–ª—ã:**
- ‚úÖ `StartGenerateDocument.php`
- ‚úÖ `StartFullGenerateDocument.php` 
- ‚úÖ `AsyncGenerateDocument.php`

### 5. –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–∞—É–∑—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

–í `StartFullGenerateDocument.php` —É–≤–µ–ª–∏—á–µ–Ω–∞ –ø–∞—É–∑–∞ –º–µ–∂–¥—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –ø–æ–¥—Ä–∞–∑–¥–µ–ª–æ–≤:

```php
// –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ thread
sleep(2);
```

### 3. –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è run

```php
public function safeCreateRun(string $threadId, string $assistantId, int $maxRetries = 5): array
{
    $attempts = 0;
    
    while ($attempts < $maxRetries) {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ run –≤ thread
            if ($this->hasActiveRuns($threadId)) {
                Log::info('Thread –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ run –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ, –æ–∂–∏–¥–∞–µ–º...', [
                    'thread_id' => $threadId,
                    'assistant_id' => $assistantId,
                    'attempt' => $attempts + 1
                ]);
                
                sleep(3);
                $attempts++;
                continue;
            }
            
            // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å run
            return $this->createRun($threadId, $assistantId);
            
        } catch (\Exception $e) {
            if (strpos($e->getMessage(), 'already has an active run') !== false) {
                // –ñ–¥–µ–º –¥–æ–ª—å—à–µ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö
                sleep(min(10, 3 + $attempts * 2));
                $attempts++;
                continue;
            }
            
            throw $e;
        }
    }
    
    throw new \Exception("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å run –ø–æ—Å–ª–µ {$maxRetries} –ø–æ–ø—ã—Ç–æ–∫.");
}
```

### 7. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö run

–î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏–π:

```php
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–º–µ–Ω–∞ –∑–∞–≤–∏—Å—à–∏—Ö run (–±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç)
$this->cancelRun($threadId, $runId);

// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ thread –æ—Ç –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö run
$this->forceCleanThread($threadId);

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ thread –µ—Å–ª–∏ —Å—Ç–∞—Ä—ã–π –±–µ–∑–Ω–∞–¥–µ–∂–Ω–æ –∑–∞–≤–∏—Å–∞–µ—Ç
$newThread = $gptService->createThread();
$this->document->update(['thread_id' => $newThread['id']]);
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** –∞–∫—Ç–∏–≤–Ω—ã—Ö run –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏–π
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** –∞–∫—Ç–∏–≤–Ω—ã—Ö run –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö run
3. **Retry –º–µ—Ö–∞–Ω–∏–∑–º** —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
4. **–û—Ç–º–µ–Ω–∞ –∑–∞–≤–∏—Å—à–∏—Ö run** (–±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
5. **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ thread** –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö
6. **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ thread** –µ—Å–ª–∏ —Å—Ç–∞—Ä—ã–π –±–µ–∑–Ω–∞–¥–µ–∂–Ω–æ –∑–∞–≤–∏—Å–∞–µ—Ç
7. **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
8. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–æ–∫** –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ API –æ—Ç–≤–µ—Ç–∞—Ö
9. **–°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞** –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ª–æ–≥–∏—Ä—É–µ—Ç:
- –ü–æ–ø—ã—Ç–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ thread
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö run
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
- –£—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### API Endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ run

```
GET /v1/threads/{thread_id}/runs
```

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö run –≤ thread —Å –∏—Ö —Å—Ç–∞—Ç—É—Å–∞–º–∏.

### –ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã run
- `queued` - –≤ –æ—á–µ—Ä–µ–¥–∏
- `in_progress` - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è  
- `requires_action` - —Ç—Ä–µ–±—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è

### –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã run
- `completed` - –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ
- `failed` - –∑–∞–≤–µ—Ä—à–µ–Ω —Å –æ—à–∏–±–∫–æ–π
- `cancelled` - –æ—Ç–º–µ–Ω–µ–Ω
- `expired` - –∏—Å—Ç–µ–∫ —Å—Ä–æ–∫

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–≥–∏:

```bash
# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
grep "while a run.*is active" storage/logs/laravel.log

# –ü–æ–∏—Å–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞
grep "safeAddMessageToThread" storage/logs/laravel.log

# –ê–∫—Ç–∏–≤–Ω—ã–µ run –≤ thread
grep "Thread –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ run" storage/logs/laravel.log
```

### 6. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–æ–∫

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –æ—Ç–≤–µ—Ç–æ–≤ API –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–µ–Ω—Ç—É:

```php
// –ë—ã–ª–æ:
$content = $response['choices'][0]['message']['content'];
$tokens = $response['usage']['total_tokens'];

// –°—Ç–∞–ª–æ:  
$content = $response['content'];
$tokens = $response['tokens_used'];
```

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –±—É–¥—É—â–µ–≥–æ

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ** `safeAddMessageToThread()` –≤–º–µ—Å—Ç–æ `addMessageToThread()`
2. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ** `safeCreateRun()` –≤–º–µ—Å—Ç–æ `createRun()`
3. **–î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–∞—É–∑—ã** –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ —Å thread (–º–∏–Ω–∏–º—É–º 2-3 —Å–µ–∫—É–Ω–¥—ã)
4. **–õ–æ–≥–∏—Ä—É–π—Ç–µ** –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å OpenAI API –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
5. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ** –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø–æ–¥–æ–±–Ω—ã—Ö –æ—à–∏–±–æ–∫
6. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–æ–≤** –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ API –º–µ—Ç–æ–¥–∞—Ö 