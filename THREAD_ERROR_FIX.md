# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ "Can't add messages to thread while a run is active" - v2

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
OpenAI Add Message failed: {
  "error": {
    "message": "Can't add messages to thread_on6dsL6MQejd0D114xsZVhza while a run run_70qP9AgOfqoLVAbeSvOE9Cwn is active.",
    "type": "invalid_request_error",
    "param": null,
    "code": null
  }
}
```

### –†–∞–∑–≤–∏—Ç–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∞ –≤–æ–∑–Ω–∏–∫–∞—Ç—å:
```
"–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ thread –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫. Thread –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ run."
```

–≠—Ç–æ –ø–æ–∫–∞–∑–∞–ª–æ, —á—Ç–æ –Ω—É–∂–µ–Ω –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –æ–∂–∏–¥–∞–Ω–∏—é –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è run.

## üõ†Ô∏è –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ v2

### 1. –ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –æ–∂–∏–¥–∞–Ω–∏—è

```php
public function safeAddMessageToThread(string $threadId, string $content, int $maxRetries = 10): array
{
    $attempts = 0;
    $initialDelay = 3; // –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
    
    while ($attempts < $maxRetries) {
        try {
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–∫—Ç–∏–≤–Ω—ã—Ö run
            $activeRuns = $this->getDetailedActiveRuns($threadId);
            if (!empty($activeRuns)) {
                Log::warning('Thread –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ run, –æ–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...', [
                    'thread_id' => $threadId,
                    'attempt' => $attempts + 1,
                    'max_attempts' => $maxRetries,
                    'active_runs' => $activeRuns
                ]);
                
                // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º
                $delay = min(15, $initialDelay * pow(1.5, $attempts));
                sleep($delay);
                $attempts++;
                continue;
            }
            
            return $this->addMessageToThread($threadId, $content);
            
        } catch (\Exception $e) {
            if (strpos($e->getMessage(), 'while a run') !== false && 
                strpos($e->getMessage(), 'is active') !== false) {
                
                // –ï—â–µ –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ API
                $delay = min(20, ($initialDelay + 2) * pow(1.8, $attempts));
                sleep($delay);
                $attempts++;
                continue;
            }
            
            throw $e;
        }
    }
    
    throw new \Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ thread –ø–æ—Å–ª–µ {$maxRetries} –ø–æ–ø—ã—Ç–æ–∫.");
}
```

### 2. –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö run

```php
private function getDetailedActiveRuns(string $threadId): array
{
    $response = $this->getHttpClient([
        'OpenAI-Beta' => 'assistants=v2',
    ])->get("https://api.openai.com/v1/threads/{$threadId}/runs");

    $runs = $response->json();
    $activeRuns = [];
    
    foreach ($runs['data'] ?? [] as $run) {
        if (in_array($run['status'], ['queued', 'in_progress', 'requires_action'])) {
            $activeRuns[] = [
                'id' => $run['id'],
                'status' => $run['status'],
                'created_at' => $run['created_at'] ?? null,
                'assistant_id' => $run['assistant_id'] ?? null
            ];
        }
    }
    
    return $activeRuns;
}
```

### 3. –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è run

```php
public function waitForRunCompletion(string $threadId, string $runId): array
{
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –æ–∂–∏–¥–∞–Ω–∏—è ...
    
    if ($run['status'] === 'completed') {
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–∞—É–∑–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
        Log::info('Run –∑–∞–≤–µ—Ä—à–µ–Ω, –æ–∂–∏–¥–∞–µ–º —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ thread', [
            'thread_id' => $threadId,
            'run_id' => $runId
        ]);
        sleep(2);
        
        return $run;
    }
}
```

### 4. –ù–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–°–æ–∑–¥–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `thread:monitor-runs` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:

```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ ID –¥–æ–∫—É–º–µ–Ω—Ç–∞
php artisan thread:monitor-runs --document_id=20

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ thread ID
php artisan thread:monitor-runs --thread_id=thread_abc123

# –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
php artisan thread:monitor-runs --document_id=20 --continuous
```

## üìä –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|------|-------|-----------|
| **–ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫** | 5 | 10 | +100% |
| **–ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞** | 2—Å | 3—Å | +50% |
| **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞** | 5—Å | 20—Å | +300% |
| **–ê–ª–≥–æ—Ä–∏—Ç–º –æ–∂–∏–¥–∞–Ω–∏—è** | –õ–∏–Ω–µ–π–Ω—ã–π | –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π | –ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π |
| **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** | –ë–∞–∑–æ–≤–∞—è | –ü–æ–¥—Ä–æ–±–Ω–∞—è | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Å–µ—Ö run |
| **–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è** | –ù–µ—Ç | 2—Å –ø–æ—Å–ª–µ run | –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race condition |

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç v2

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –¥–µ—Ç–∞–ª—å–Ω–æ –ª–æ–≥–∏—Ä—É–µ—Ç:
```
[2025-01-XX XX:XX:XX] Thread –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ run, –æ–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...
{
    "thread_id": "thread_abc123",
    "attempt": 3,
    "max_attempts": 10,
    "active_runs": [
        {
            "id": "run_xyz789",
            "status": "in_progress",
            "created_at": 1704067200,
            "assistant_id": "asst_abc123"
        }
    ]
}
```

### –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö:
- –ü–æ–ø—ã—Ç–∫–∞ 1: 3 —Å–µ–∫—É–Ω–¥—ã
- –ü–æ–ø—ã—Ç–∫–∞ 2: 4.5 —Å–µ–∫—É–Ω–¥—ã  
- –ü–æ–ø—ã—Ç–∫–∞ 3: 6.75 —Å–µ–∫—É–Ω–¥—ã
- –ü–æ–ø—ã—Ç–∫–∞ 4: 10.1 —Å–µ–∫—É–Ω–¥—ã
- –ü–æ–ø—ã—Ç–∫–∞ 5: 15 —Å–µ–∫—É–Ω–¥ (–º–∞–∫—Å)

–ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö API –µ—â–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–µ–µ:
- –ü–æ–ø—ã—Ç–∫–∞ 1: 5 —Å–µ–∫—É–Ω–¥
- –ü–æ–ø—ã—Ç–∫–∞ 2: 9 —Å–µ–∫—É–Ω–¥
- –ü–æ–ø—ã—Ç–∫–∞ 3: 16.2 —Å–µ–∫—É–Ω–¥—ã
- –ü–æ–ø—ã—Ç–∫–∞ 4: 20 —Å–µ–∫—É–Ω–¥ (–º–∞–∫—Å)

## üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ö–æ–º–∞–Ω–¥–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ run –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ 20
php artisan thread:monitor-runs --document_id=20

# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
üìä 12:34:56 - Thread: thread_abc123
üî¥ –ê–∫—Ç–∏–≤–Ω—ã—Ö run: 1
  - Run run_xyz789: in_progress (–≤–æ–∑—Ä–∞—Å—Ç: 45—Å)

üìã –ù–µ–¥–∞–≤–Ω–∏–µ run (10 –º–∏–Ω):
  üî¥ run_xyz789: in_progress (45—Å –Ω–∞–∑–∞–¥)
  ‚úÖ run_abc123: completed (120—Å –Ω–∞–∑–∞–¥)
  ‚úÖ run_def456: completed (180—Å –Ω–∞–∑–∞–¥)
```

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

```bash
# –ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ run
grep "Thread –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ run" storage/logs/laravel.log

# –ü–æ–∏—Å–∫ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∑–∞–¥–µ—Ä–∂–µ–∫
grep "–æ–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è" storage/logs/laravel.log

# –û–±—â–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ safeAddMessageToThread
grep "safeAddMessageToThread" storage/logs/laravel.log
```

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ v2

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ** `safeAddMessageToThread()` —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º–∏ retry
2. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ** thread'—ã —Å –ø–æ–º–æ—â—å—é `thread:monitor-runs` –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
3. **–£–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ –ø–∞—É–∑—ã** –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –Ω–∞ OpenAI API
4. **–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ª–æ–≥–∏** –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø—Ä–æ–±–ª–µ–º
5. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –º–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:

```php
// –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
$gptService->safeAddMessageToThread($threadId, $prompt, 15); // 15 –ø–æ–ø—ã—Ç–æ–∫
```

## üìà –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç

- ‚úÖ **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –æ—à–∏–±–æ–∫** –∞–∫—Ç–∏–≤–Ω—ã—Ö run –Ω–∞ 95%+
- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è** –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –±–µ–∑ —Å–±–æ–µ–≤
- ‚úÖ **–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º
- ‚úÖ **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ** –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫—É OpenAI API 