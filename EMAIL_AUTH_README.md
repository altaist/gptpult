# Авторизация по Email

## Описание
Добавлена возможность авторизации пользователей по email с использованием одноразового кода подтверждения. Система больше НЕ принуждает к автоматической авторизации - пользователь может выбрать способ входа.

## Как это работает

1. **Ввод email**: Пользователь вводит свой email адрес на странице `/email-auth`
2. **Отправка кода**: Система генерирует 6-значный код и отправляет его на указанный email
3. **Ввод кода**: Пользователь вводит полученный код
4. **Авторизация**: При правильном коде пользователь автоматически авторизуется

## Изменения в логике авторизации

### Старое поведение
- Автоматическая авторизация/регистрация при загрузке страниц
- Принудительное создание аккаунтов
- Конфликт между разными способами авторизации

### Новое поведение
- **Выбор пользователя**: На странице `/login` пользователь видит варианты:
  - Войти по почте (рекомендуется)
  - Автоматическая авторизация
  - Войти с паролем
- **Проверка сессии**: Автоматически проверяется только существующая авторизация
- **Нет принуждения**: Система не создаёт аккаунты без явного запроса

## Новые файлы и изменения

### База данных
- **Миграция**: `2025_06_29_113949_add_email_verification_code_to_users_table.php`
  - Добавлены поля `email_verification_code` и `email_verification_expires_at` в таблицу `users`

### Backend
- **Контроллер**: `app/Http/Controllers/Auth/EmailAuthController.php`
  - `showEmailForm()` - отображение формы ввода email
  - `sendCode()` - отправка кода на email
  - `verifyCode()` - проверка кода и авторизация
  - `resendCode()` - повторная отправка кода

- **Уведомление**: `app/Notifications/EmailVerificationCode.php`
  - Красивое email уведомление с кодом подтверждения

- **Модель User**: обновлена для поддержки новых полей

### Frontend
- **Страница**: `resources/js/pages/Auth/EmailAuth.vue`
  - Двухэтапная форма: ввод email → ввод кода
  - Валидация и обработка ошибок
  - Возможность повторной отправки кода

- **Обновления**: 
  - `resources/js/pages/Auth/Login.vue` - новый дизайн с выбором способа авторизации
  - `resources/js/composables/auth.js` - новая функция `checkAuthOnly()` без автоматической регистрации
  - `resources/js/pages/Welcome.vue` - убрана принудительная авторизация
  - `resources/js/pages/documents/NewDocument.vue` - убрана принудительная авторизация

### Маршруты
```php
// routes/auth.php
Route::get('email-auth', [EmailAuthController::class, 'showEmailForm'])->name('email-auth');
Route::post('email-auth/send-code', [EmailAuthController::class, 'sendCode'])->name('email-auth.send-code');
Route::post('email-auth/verify-code', [EmailAuthController::class, 'verifyCode'])->name('email-auth.verify-code');
Route::post('email-auth/resend-code', [EmailAuthController::class, 'resendCode'])->name('email-auth.resend-code');
```

## Настройка

### 1. Применить миграцию
```bash
php artisan migrate
```

### 2. Настроить почту в .env
```env
MAIL_MAILER=smtp
MAIL_HOST=smtp.example.com
MAIL_PORT=587
MAIL_USERNAME=your-email@example.com
MAIL_PASSWORD=your-password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=your-email@example.com
MAIL_FROM_NAME="${APP_NAME}"
```

### 3. Настроить очереди (рекомендуется)
```env
QUEUE_CONNECTION=database
```

```bash
php artisan queue:work
```

## Способы авторизации

### 1. По Email (Рекомендуется)
- Переход на `/email-auth`
- Ввод email → получение кода → ввод кода
- Автоматическое создание аккаунта при первом входе

### 2. Автоматическая авторизация
- Для пользователей Telegram WebApp
- На основе localStorage токенов
- Создание временных аккаунтов

### 3. Классическая (Email + Пароль)
- Обычная форма логина
- Требует предварительной регистрации

## Особенности

- **Автоматическое создание пользователей**: При авторизации по email создаётся аккаунт, если его нет
- **Безопасность**: Код действителен только 10 минут
- **Одноразовость**: Код можно использовать только один раз
- **Очереди**: Уведомления отправляются через систему очередей
- **UX**: Удобный интерфейс с валидацией и возможностью повторной отправки
- **Выбор пользователя**: Нет принудительной авторизации

## Использование

### Новый пользователь
1. Переходит на сайт
2. Видит варианты авторизации на `/login`
3. Выбирает "Войти по почте"
4. Вводит email → получает код → авторизуется

### Telegram пользователь
1. Переходит через Telegram WebApp
2. Может выбрать "Автоматическую авторизацию"
3. Система создаёт аккаунт на основе Telegram данных

### Существующий пользователь
1. Система автоматически проверяет сессию
2. Если авторизован - перенаправляет в ЛК
3. Если нет - даёт выбор способа входа

## Дополнительные возможности

- **Изменение email**: На этапе ввода кода можно вернуться и изменить email
- **Повторная отправка**: Если код не пришел, можно запросить новый
- **Валидация**: Только цифры в поле кода, автоматическая проверка длины
- **Связывание аккаунтов**: Документы созданные без авторизации связываются с аккаунтом

## Безопасность

- Коды имеют ограниченное время жизни (10 минут)
- Старые коды автоматически становятся недействительными при генерации новых
- Коды очищаются после успешной авторизации
- Проверка на существование пользователя и валидность кода
- Нет принудительного создания аккаунтов без согласия пользователя

## Тестирование

Для тестирования отправки email можно использовать:

```bash
# Тестирование в среде разработки (логи в файл)
MAIL_MAILER=log

# Для реальной отправки настройте SMTP параметры в .env
``` 